name: Generate OpenSCAD Docs (Markdown → Pages)

on:
  push:
    branches: [ main ]
    paths:
      - "**/*.scad"
      - ".github/workflows/**"

permissions:
  contents: write

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openscad python3 python3-pip
          pip3 install openscad-docsgen
      
      -name: List .scad files
        run: |
    `````echo "Scanning for .scad files..."
    `````find . -type f -name '*.scad' \
      `````! -path './.git/*' \
      `````! -path './public/*' \
      `````| sort

      - name: Generate Markdown docs
        run: |
          set -e
          mkdir -p public

          find . -type f -name '*.scad' \
            ! -path './.git/*' \
            ! -path './public/*' \
            | while read -r scad; do

              outdir="public/$(dirname "$scad")"
              mkdir -p "$outdir"

              echo "Generating docs for $scad"
              openscad-docsgen -D "$outdir" "$scad"

              # openscad-docsgen creates an extra "docs/" directory — flatten it
              if [ -d "$outdir/docs" ]; then
                mv "$outdir/docs"/*.md "$outdir/"
                rmdir "$outdir/docs"
              fi
            done

      - name: Generate index
        run: |
          echo "# OpenSCAD Documentation" > public/index.md
          echo "" >> public/index.md

          find public -name '*.md' ! -name index.md \
            | sed 's|^public/||' \
            | sort \
            | while read f; do
                echo "- [${f}](${f})" >> public/index.md
              done

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
